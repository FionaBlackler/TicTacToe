<!DOCTYPE html>
<html>
  <head>
    <title>TicTacToe Game</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js" integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em" crossorigin="anonymous"></script>
  </head>
  <body>
    <h1 class="title">TicTacToe</h1>
        <div id="result"></div>
        <div class="container">      
            <p class="instructions">
                Game starts by clicking on a box.<br>
                First Player starts as <span id="playerX"><b>Player X</b></span><br>
                and<br>
                Second Player as <span id="playerO"><b>Player O</b></span> 
            </p>
            <div class="board">
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell"></div>
            </div>              
            <button class="restart" id="restart"><b>Restart</b></button>
        </div>
        <p class="footer">         
          <small>Brought to you by Tobias Mayer, Felix Walker, Fiona Blackler</small>
        </p>
        <script src="/socket.io/socket.io.js"></script>
        <script>
          var socket = io();

          // const userIds = [];
          // if (userIds <= 0) {
          // var userId = prompt("Enter a name");
          // } else {
            
          // }
          // userIds.push("userId");

          var currentPlayer = 'X';
          var button = document.getElementById('restart');
          const cells = Array.from(document.querySelectorAll(".cell"));

          const PLAYERX_WON = 'PLAYERX_WON';
          const PLAYERO_WON = 'PLAYERO_WON';
          const TIE = 'TIE';
          var isGameActive = true;
          var board = ['', '', '', '', '', '', '', '', ''];

          const winningConditions = [
              [0, 1, 2],
              [3, 4, 5],
              [6, 7, 8],
              [0, 3, 6],
              [1, 4, 7],
              [2, 5, 8],
              [0, 4, 8],
              [2, 4, 6]
          ];
          
          function handleResultValidation() {
            let roundWon = false;
            for (let i = 0; i <= 7; i++) {
                const winCondition = winningConditions[i];
                const a = board[winCondition[0]];
                const b = board[winCondition[1]];
                const c = board[winCondition[2]];
                if (a === '' || b === '' || c === '') {
                    continue;
                }
                if (a === b && b === c) {
                    roundWon = true;
                    break;
                }
            }

            if (roundWon) {
              socket.emit('player won', currentPlayer);
            }
            if (!board.includes('')) {
              socket.emit('player tie', TIE);
            }
          }

          //Achtet auf click die data senden
          cells.forEach( (cell, index) => {
              cell.addEventListener('click', event => {
                if (cell.textContent === "" && isGameActive) {
                  socket.emit('player move', index);
                }
              });
          });

          //Reset button click
          button.addEventListener('click', event => {
            if (!isGameActive) {
             socket.emit('reset board',);
            }
          });
          
          //
          //SOCKET.ONs
          //

          //Reaktion wenn spieler gewinnt
          socket.on('player won', function(data) {
            isGameActive = false;
            gameResult = data === 'X' ? PLAYERX_WON : PLAYERO_WON
            var resultBox = document.getElementById('result');
            resultBox.textContent = gameResult;
          });

          //Reaktion wenn spiele unentschieden
          socket.on('player tie', function(data) {
            isGameActive = false;
            var resultBox = document.getElementById('result');
            gameResult = data;
            resultBox.textContent = gameResult;
          });

          //Reaktionen auf empfangene data
          socket.on('player move', function(data) {
            //set Player Color
            if (currentPlayer==="X") {
            cells[data].setAttribute("id","playerX");
            } else {
            cells[data].setAttribute("id","playerO");
            }
            //add board state
            board[data] = currentPlayer;
            //set X or O in clicked cell
            cells[data].textContent = currentPlayer;
            handleResultValidation();
            //switch players
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
          });

          //Reset board moves
          socket.on('reset board', function(data) {
            //set game activ
            isGameActive=true;
            //reset player turn
            currentPlayer = 'X';
            //reset moves
            cells.forEach( (cell, index) => {
              board[index] = "";
              cell.textContent = "";
            });
            resultBox.textContent = "";
          });

        </script>
    </script>
  </body>
</html>